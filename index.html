<!doctype html>
<html translate="no">
<head>
    <!-- Previous head content remains unchanged -->
</head>
<body>
    <div id="root">
        <div class="swap-container">
            <h2>Swap on Pharos Testnet</h2>
            <div id="balance" class="status">Balance: Loading...</div>
            <div id="txnCount" class="status">Total Transactions: 0</div> <!-- Added transaction count display -->
            <button id="connectWallet">Connect Wallet</button>
            <select id="token1">
                <option value="0x76aaada469d23216be5f7c596fa25f282ff9b364">WPHRS</option>
                <option value="0xad902cf99c2de2f1ba5ec4d642fd7e49cae9ee37">USDT</option>
            </select>
            <input type="number" id="amount1" placeholder="Amount to swap" min="0" step="0.01"/>
            <select id="token2">
                <option value="0xad902cf99c2de2f1ba5ec4d642fd7e49cae9ee37">USDT</option>
                <option value="0x76aaada469d23216be5f7c596fa25f282ff9b364">WPHRS</option>
            </select>
            <input type="number" id="swapCount" placeholder="Number of swaps (1-10)" min="1" max="10" step="1" value="1"/>
            <button id="approveButton" disabled>Approve Tokens</button>
            <button id="swapButton" disabled>Swap Tokens</button>
            <div id="status" class="status">Please connect your wallet to start swapping.</div>
            <div id="txnLinks" class="status"></div>
        </div>
    </div>
    <div id="background-radial-gradient"></div>
    <script>
        // Previous configurations (pharosTestnet, swapContractAddress, swapContractABI, erc20ABI) remain unchanged

        let web3, accounts, swapContract, totalTxnCount = 0; // Added transaction counter

        function updateTxnCount() {
            document.getElementById('txnCount').textContent = `Total Transactions: ${totalTxnCount}`;
        }

        async function updateBalance() {
            if (!accounts || !web3) return;
            const token1 = document.getElementById('token1').value;
            const tokenContract = new web3.eth.Contract(erc20ABI, web3.utils.toChecksumAddress(token1));
            try {
                const balance = await tokenContract.methods.balanceOf(accounts[0]).call();
                const balanceInEther = web3.utils.fromWei(balance, 'ether');
                document.getElementById('balance').textContent = `Balance: ${parseFloat(balanceInEther).toFixed(4)} ${token1 === '0x76aaada469d23216be5f7c596fa25f282ff9b364' ? 'WPHRS' : 'USDT'}`;
            } catch (error) {
                document.getElementById('balance').textContent = 'Balance: Error fetching balance';
            }
        }

        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    document.getElementById('connectWallet').textContent = `Connected: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                    document.getElementById('approveButton').disabled = false;
                    document.getElementById('status').textContent = 'Wallet connected. Approve tokens to swap.';
                    await switchToPharosTestnet();
                    swapContract = new web3.eth.Contract(swapContractABI, web3.utils.toChecksumAddress(swapContractAddress));
                    await updateBalance();
                    document.getElementById('token1').addEventListener('change', updateBalance);
                    updateTxnCount(); // Initialize transaction count display
                } catch (error) {
                    document.getElementById('status').textContent = 'Error connecting wallet: ' + error.message;
                }
            } else {
                document.getElementById('status').textContent = 'Please install MetaMask to use this feature.';
            }
        }

        async function switchToPharosTestnet() {
            // Unchanged from previous version
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: pharosTestnet.chainId }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [pharosTestnet]
                        });
                    } catch (addError) {
                        document.getElementById('status').textContent = 'Error adding Pharos Testnet: ' + addError.message;
                    }
                } else {
                    document.getElementById('status').textContent = 'Error switching to Pharos Testnet: ' + switchError.message;
                }
            }
        }

        async function approveTokens() {
            const token1 = document.getElementById('token1').value;
            const amount1 = document.getElementById('amount1').value;
            const swapCount = parseInt(document.getElementById('swapCount').value);
            const status = document.getElementById('status');

            if (!token1 || !amount1 || amount1 <= 0 || !swapCount || swapCount < 1 || swapCount > 10) {
                status.textContent = 'Please select a token, enter a valid amount, and a swap count (1-10).';
                return;
            }

            if (!accounts || !web3) {
                status.textContent = 'Please connect your wallet first.';
                return;
            }

            try {
                const checksumToken1 = web3.utils.toChecksumAddress(token1);
                const checksumSwapContract = web3.utils.toChecksumAddress(swapContractAddress);
                status.textContent = 'Checking allowance...';
                const tokenContract = new web3.eth.Contract(erc20ABI, checksumToken1);
                const amountIn = web3.utils.toWei(amount1, 'ether');
                const totalAmount = web3.utils.toBN(amountIn).muln(swapCount);
                const allowance = await tokenContract.methods.allowance(accounts[0], checksumSwapContract).call();

                if (web3.utils.toBN(allowance).lt(totalAmount)) {
                    status.textContent = 'Approving tokens...';
                    const tx = await tokenContract.methods.approve(checksumSwapContract, totalAmount).send({ 
                        from: accounts[0],
                        gasPrice: await web3.eth.getGasPrice() * 1.2
                    });
                    totalTxnCount++; // Increment transaction count
                    updateTxnCount(); // Update display
                    status.textContent = 'Tokens approved! You can now swap.';
                    document.getElementById('txnLinks').innerHTML += `<div>Approval Tx: <a href="${pharosTestnet.blockExplorerUrls[0]}/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash.slice(0, 6)}...${tx.transactionHash.slice(-4)}</a></div>`;
                } else {
                    status.textContent = 'Sufficient allowance already exists. You can swap.';
                }
                document.getElementById('approveButton').disabled = true;
                document.getElementById('swapButton').disabled = false;
                await updateBalance();
            } catch (error) {
                status.textContent = 'Approval failed: ' + error.message;
            }
        }

        async function swapTokens() {
            const token1 = document.getElementById('token1').value;
            const token2 = document.getElementById('token2').value;
            const amount1 = document.getElementById('amount1').value;
            const swapCount = parseInt(document.getElementById('swapCount').value);
            const status = document.getElementById('status');
            const txnLinks = document.getElementById('txnLinks');

            if (!token1 || !token2 || !amount1 || amount1 <= 0 || !swapCount || swapCount < 1 || swapCount > 10) {
                status.textContent = 'Please select tokens, enter a valid amount, and a swap count (1-10).';
                return;
            }

            if (!accounts || !swapContract) {
                status.textContent = 'Please connect your wallet and approve tokens first.';
                return;
            }

            try {
                const checksumToken1 = web3.utils.toChecksumAddress(token1);
                const checksumToken2 = web3.utils.toChecksumAddress(token2);
                const amountIn = web3.utils.toWei(amount1, 'ether');
                const amountOutMin = 0;
                const path = [checksumToken1, checksumToken2];
                const deadline = Math.floor(Date.now() / 1000) + 60 * 5;

                status.textContent = `Initiating ${swapCount} swap(s)...`;
                const swapPromises = [];
                for (let i = 1; i <= swapCount; i++) {
                    status.textContent = `Preparing swap ${i} of ${swapCount}...`;
                    const gasPrice = await web3.eth.getGasPrice() * 1.2;
                    swapPromises.push(
                        swapContract.methods.swapExactTokensForTokens(
                            amountIn,
                            amountOutMin,
                            path,
                            accounts[0],
                            deadline
                        ).send({ 
                            from: accounts[0],
                            gasPrice: gasPrice
                        }).then(tx => ({
                            index: i,
                            hash: tx.transactionHash
                        }))
                    );
                }

                const results = await Promise.allSettled(swapPromises);
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        const { index: swapIndex, hash } = result.value;
                        totalTxnCount++; // Increment transaction count for each successful swap
                        updateTxnCount(); // Update display
                        status.textContent = `Swap ${swapIndex} of ${swapCount} successful!`;
                        txnLinks.innerHTML += `<div>Swap ${swapIndex} Tx: <a href="${pharosTestnet.blockExplorerUrls[0]}/tx/${hash}" target="_blank">${hash.slice(0, 6)}...${hash.slice(-4)}</a></div>`;
                    } else {
                        status.textContent = `Swap ${index + 1} failed: ${result.reason.message}`;
                    }
                });

                status.textContent = `All ${swapCount} swaps completed! You can swap again.`;
                document.getElementById('approveButton').disabled = false;
                document.getElementById('swapButton').disabled = true;
                await updateBalance();
            } catch (error) {
                status.textContent = 'Swap failed: ' + error.message;
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', initWeb3);
        document.getElementById('approveButton').addEventListener('click', approveTokens);
        document.getElementById('swapButton').addEventListener('click', swapTokens);
    </script>
</body>
</html>
