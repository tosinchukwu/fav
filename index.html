<!doctype html>
<html translate="no">
<head>
    <meta charset="utf-8"/>
    <title>Testing: Pharos Testnet</title>
    <meta name="description" content="A secure and lightning-fast DEX on Pharos Network for seamless crypto trading."/>
    <link rel="shortcut icon" type="image/jpg" href="/favicon.svg"/>
    <link rel="apple-touch-icon" sizes="192x192" href="/images/192x192_App_Icon.png"/>
    <link rel="apple-touch-icon" sizes="512x512" href="/images/512x512_App_Icon.png"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <meta name="theme-color" content="#fff"/>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' 'wasm-unsafe-eval' data: https://translate.googleapis.com/ https://vercel.com https://vercel.live/ https://www.google-analytics.com https://www.googletagmanager.com https://challenges.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src * 'self' blob: data: https://assets.coingecko.com/ https://cdn.center.app/ https://ethereum-optimism.github.io/ https://explorer-api.walletconnect.com/ https://i.seadn.io/ https://lh3.googleusercontent.com/ https://openseauserdata.com/ https://raw.githubusercontent.com/ https://raw.seadn.io/ https://s2.coinmarketcap.com/ https://static.optimism.io/ https://vercel.com https://vercel.live/ https://trustwallet.com/ https://cloudflare-ipfs.com/ https://challenges.cloudflare.com; frame-src 'self' https://buy.moonpay.com/ https://vercel.com https://vercel.live/ https://verify.walletconnect.com/ https://verify.walletconnect.org/ https://challenges.cloudflare.com; connect-src * 'self' blob: data: https://statsigapi.net https://api.moonpay.com/ https://api.opensea.io https://api.thegraph.com/ https://arbitrum-mainnet.infura.io/ https://avalanche-mainnet.infura.io/ https://base-mainnet.infura.io/ https://bridge.arbitrum.io https://celo-org.github.io https://cloudflare-ipfs.com https://explorer-api.walletconnect.com https://forno.celo.org/ https://gateway.ipfs.io/ https://mainnet.infura.io https://o1037921.ingest.sentry.io https://old-wispy-arrow.bsc.quiknode.pro/ https://optimism-mainnet.infura.io/ https://polygon-mainnet.infura.io/ https://raw.githubusercontent.com https://static.optimism.io https://tokenlist.arbitrum.io/ https://tokens.coingecko.com https://ultra-blue-flower.quiknode.pro https://vercel.com https://vercel.live/ https://www.gemini.com wss://relay.walletconnect.com/ wss://www.walletlink.org/rpc https://challenges.cloudflare.com https://rpc.testnet.pharosnetwork.xyz; worker-src 'self' blob:;"/>
    <meta name="apple-itunes-app" content="app-id=6443944476"/>
    <link rel="manifest" href="/manifest.json"/>
    <link rel="preconnect" href="https://main-subgraph.__HOST__.com/" crossorigin/>
    <link rel="preconnect" href="https://mainnet.infura.io/" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-Black.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-BlackItalic.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-BoldItalic.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-Italic.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-Light.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-LightItalic.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-Medium.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-MediumItalic.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/Thin.ttf" as="font" type="font/ttf" crossorigin/>
    <link rel="preload" href="/fonts/ThinItalic.ttf" as="font" type="font/ttf" crossorigin/>
    <meta property="og:title" content="Zenithswap: Trading cryptocurrency"/>
    <meta property="og:description" content="A secure and lightning-fast DEX on Pharos Network for seamless crypto trading."/>
    <meta property="og:url" content="https://www.__HOST__.com/"/>
    <meta property="og:site_name" content="Zenithswap: Trading cryptocurrency"/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:image:url" content="https://testnet.zenithswap.xyz/images/zenith-twitter.jpg?v=2"/>
    <meta property="og:image:width" content="192"/>
    <meta property="og:image:height" content="192"/>
    <meta property="og:image:alt" content="Zenithswap Logo"/>
    <meta property="og:type" content="website"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="Zenithswap: Trading cryptocurrency"/>
    <meta name="twitter:description" content="A secure and lightning-fast DEX on Pharos Network for seamless crypto trading."/>
    <meta name="twitter:image" content="https://testnet.zenithswap.xyz/images/zenith-twitter.jpg?v=2"/>
    <style>
        * {
            font-family: "DM Sans";
            box-sizing: border-box;
        }
        @font-face {
            font-family: "DM Sans";
            font-weight: 600;
            font-style: normal;
            font-display: block;
            src: url("/fonts/DMSans-Medium.ttf") format("truetype");
        }
        @font-face {
            font-family: "DM Sans";
            font-weight: 500;
            font-style: normal;
            font-display: block;
            src: url("/fonts/DMSans-Medium.ttf") format("truetype");
        }
        @supports (font-variation-settings: normal) {
            * {
                font-family: "DM Sans";
            }
        }
        body, html {
            margin: 0;
            padding: 0;
        }
        button {
            user-select: none;
        }
        html {
            font-size: 16px;
            font-weight: 500;
            font-variant: none;
            font-smooth: always;
            text-rendering: optimizeLegibility !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        #background-radial-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            pointer-events: none;
            width: 200vw;
            height: 200vh;
            transform: translate(-50vw, -100vh);
            z-index: -1;
        }
        #root, body, html {
            min-height: 100%;
        }
        @media (prefers-color-scheme: dark) {
            html {
                background: linear-gradient(#131313 0, #131313 100%);
            }
        }
        @media (prefers-color-scheme: light) {
            html {
                background: radial-gradient(100% 100% at 50% 0, rgba(255, 184, 226, 0) 0, rgba(255, 255, 255, 0) 100%), #fff;
            }
        }
        .swap-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .swap-container select, .swap-container input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: "DM Sans";
            font-size: 16px;
        }
        .swap-container button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-family: "DM Sans";
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        .swap-container button:hover {
            background: #0056b3;
        }
        .swap-container button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #333;
        }
        .network-status {
            font-size: 12px;
            color: #666;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script defer="defer" src="/static/js/880.2082fd26.js"></script>
    <script defer="defer" src="/static/js/232.b34f18d1.js"></script>
    <script defer="defer" src="/static/js/830.b7bb047b.js"></script>
    <script defer="defer" src="/static/js/966.93fb1677.js"></script>
    <script defer="defer" src="/static/js/311.73876aa5.js"></script>
    <script defer="defer" src="/static/js/726.ded68954.js"></script>
    <script defer="defer" src="/static/js/main.3b6f0e39.js"></script>
    <link href="/static/css/830.07c7c7cb.css" rel="stylesheet">
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root">
        <div class="swap-container">
            <h2>Swap on Pharos Testnet</h2>
            <div id="balance" class="status">Balance: Not connected</div>
            <div id="txnCount" class="status">Total Transactions: 0</div>
            <div id="networkStatus" class="network-status">Network: Disconnected</div>
            <button id="connectWallet">Connect Wallet</button>
            <select id="token1">
                <option value="0x76aaada469d23216be5f7c596fa25f282ff9b364">WPHRS</option>
                <option value="0xad902cf99c2de2f1ba5ec4d642fd7e49cae9ee37">USDT</option>
            </select>
            <input type="number" id="amount1" placeholder="Amount to swap" min="0.0001" step="0.0001"/>
            <select id="token2">
                <option value="0xad902cf99c2de2f1ba5ec4d642fd7e49cae9ee37">USDT</option>
                <option value="0x76aaada469d23216be5f7c596fa25f282ff9b364">WPHRS</option>
            </select>
            <input type="number" id="swapCount" placeholder="Number of swaps (1-10)" min="1" max="10" step="1" value="1"/>
            <button id="approveButton" disabled>Approve Tokens</button>
            <button id="swapButton" disabled>Swap Tokens</button>
            <div id="status" class="status">Please connect your wallet to start swapping.</div>
            <div id="txnLinks" class="status"></div>
        </div>
    </div>
    <div id="background-radial-gradient"></div>
    <script>
        "undefined" != typeof window && (window.Browser = { T: () => {} });

        // Pharos Testnet configuration
        const pharosTestnet = {
            chainId: '0xa8110',
            chainName: 'Pharos Testnet',
            nativeCurrency: { name: 'PHRS', symbol: 'PHRS', decimals: 18 },
            rpcUrls: ['https://rpc.testnet.pharosnetwork.xyz'],
            blockExplorerUrls: ['https://testnet.pharosscan.xyz']
        };

        // Zenithswap contract configuration
        const swapContractAddress = '0x1A4dE519154aE51200b0Ad7C90F7FaC75547888A';
        const swapContractABI = [
            {
                "inputs": [
                    { "internalType": "uint256", "name": "amountIn", "type": "uint256" },
                    { "internalType": "uint256", "name": "amountOutMin", "type": "uint256" },
                    { "internalType": "address[]", "name": "path", "type": "address[]" },
                    { "internalType": "address", "name": "to", "type": "address" },
                    { "internalType": "uint256", "name": "deadline", "type": "uint256" }
                ],
                "name": "swapExactTokensForTokens",
                "outputs": [{ "internalType": "uint256[]", "name": "amounts", "type": "uint256[]" }],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "collectionAndSelfcalls", "type": "uint256" },
                    { "internalType": "bytes[]", "name": "data", "type": "bytes[]" }
                ],
                "name": "multicall",
                "outputs": [
                    { "internalType": "bytes[]", "name": "results", "type": "bytes[]" }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // ERC-20 ABI for token approval, allowance, and balance
        const erc20ABI = [
            {
                "constant": false,
                "inputs": [
                    { "name": "_spender", "type": "address" },
                    { "name": "_value", "type": "uint256" }
                ],
                "name": "approve",
                "outputs": [{ "name": "", "type": "bool" }],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    { "name": "_owner", "type": "address" },
                    { "name": "_spender", "type": "address" }
                ],
                "name": "allowance",
                "outputs": [{ "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{ "name": "_owner", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let web3, accounts, swapContract, totalTxnCount = 0, isApproved = false;

        function updateTxnCount() {
            document.getElementById('txnCount').textContent = `Total Transactions: ${totalTxnCount}`;
        }

        async function updateBalance() {
            if (!web3 || !accounts || accounts.length === 0) {
                document.getElementById('balance').textContent = 'Balance: Not connected';
                return;
            }
            const token1 = document.getElementById('token1').value;
            try {
                const tokenContract = new web3.eth.Contract(erc20ABI, web3.utils.toChecksumAddress(token1));
                const balance = await tokenContract.methods.balanceOf(accounts[0]).call();
                const balanceInEther = web3.utils.fromWei(balance, 'ether');
                document.getElementById('balance').textContent = `Balance: ${parseFloat(balanceInEther).toFixed(4)} ${token1 === '0x76aaada469d23216be5f7c596fa25f282ff9b364' ? 'WPHRS' : 'USDT'}`;
            } catch (error) {
                document.getElementById('balance').textContent = 'Balance: Error fetching balance';
                console.error('Balance fetch error:', error.message, error.stack);
            }
        }

        async function updateNetworkStatus() {
            if (!web3) {
                document.getElementById('networkStatus').textContent = 'Network: Disconnected';
                return;
            }
            try {
                const chainId = await web3.eth.getChainId();
                const chainIdHex = '0x' + chainId.toString(16);
                document.getElementById('networkStatus').textContent = `Network: ${chainIdHex === pharosTestnet.chainId ? 'Pharos Testnet' : 'Wrong network (Expected Pharos Testnet)'}`;
            } catch (error) {
                document.getElementById('networkStatus').textContent = 'Network: Error checking network';
                console.error('Network status error:', error.message, error.stack);
            }
        }

        async function initWeb3() {
            const status = document.getElementById('status');
            if (!window.ethereum) {
                status.textContent = 'Please install MetaMask to use this feature.';
                return;
            }

            try {
                web3 = new Web3(window.ethereum);
                
                // Request account access directly
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                } catch (error) {
                    if (error.code === 4001) {
                        status.textContent = 'Connection rejected. Please approve MetaMask connection.';
                    } else {
                        status.textContent = `Error connecting wallet: ${error.code ? `Code ${error.code}: ` : ''}${error.message || 'Unknown error'}`;
                    }
                    console.error('Account access error:', error.message, error.stack);
                    return;
                }

                document.getElementById('connectWallet').textContent = `Connected: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                document.getElementById('approveButton').disabled = false;
                status.textContent = 'Wallet connected. Approve tokens or swap if already approved.';
                
                // Switch to Pharos Testnet
                await switchToPharosTestnet();
                
                // Initialize contract
                swapContract = new web3.eth.Contract(swapContractABI, web3.utils.toChecksumAddress(swapContractAddress));
                
                // Check if already approved
                await checkAllowance();
                
                // Update balance, network status, and transaction count
                await updateBalance();
                await updateNetworkStatus();
                updateTxnCount();
                
                // Add MetaMask event listeners
                window.ethereum.on('accountsChanged', (newAccounts) => {
                    accounts = newAccounts;
                    if (accounts.length === 0) {
                        status.textContent = 'Wallet disconnected. Please reconnect.';
                        document.getElementById('connectWallet').textContent = 'Connect Wallet';
                        document.getElementById('approveButton').disabled = true;
                        document.getElementById('swapButton').disabled = true;
                    } else {
                        document.getElementById('connectWallet').textContent = `Connected: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                        status.textContent = 'Wallet account changed. Approve tokens or swap if already approved.';
                    }
                    updateBalance();
                    checkAllowance();
                });

                window.ethereum.on('chainChanged', async () => {
                    await updateNetworkStatus();
                    if ((await web3.eth.getChainId()).toString(16) !== pharosTestnet.chainId.slice(2)) {
                        status.textContent = 'Switched to wrong network. Please switch back to Pharos Testnet.';
                        document.getElementById('approveButton').disabled = true;
                        document.getElementById('swapButton').disabled = true;
                    } else {
                        status.textContent = 'Switched to Pharos Testnet. Approve tokens or swap if already approved.';
                        await checkAllowance();
                    }
                });
            } catch (error) {
                status.textContent = `Error connecting wallet: ${error.code ? `Code ${error.code}: ` : ''}${error.message || 'Unknown error'}`;
                console.error('Web3 initialization error:', error.message, error.stack);
            }
        }

        async function switchToPharosTestnet() {
            const status = document.getElementById('status');
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: pharosTestnet.chainId }]
                });
                await updateNetworkStatus();
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [pharosTestnet]
                        });
                        await updateNetworkStatus();
                    } catch (addError) {
                        status.textContent = `Error adding Pharos Testnet: ${addError.code ? `Code ${addError.code}: ` : ''}${addError.message || 'Unknown error'}`;
                        console.error('Add chain error:', addError.message, addError.stack);
                    }
                } else {
                    status.textContent = `Error switching to Pharos Testnet: ${switchError.code ? `Code ${switchError.code}: ` : ''}${switchError.message || 'Unknown error'}`;
                    console.error('Switch chain error:', switchError.message, switchError.stack);
                }
            }
        }

        async function checkAllowance() {
            const token1 = document.getElementById('token1').value;
            const amount1 = document.getElementById('amount1').value;
            const swapCount = parseInt(document.getElementById('swapCount').value);
            const status = document.getElementById('status');
            
            if (!token1 || !amount1 || amount1 <= 0 || !swapCount || swapCount < 1 || swapCount > 10) {
                return;
            }

            try {
                const checksumToken1 = web3.utils.toChecksumAddress(token1);
                const checksumSwapContract = web3.utils.toChecksumAddress(swapContractAddress);
                const tokenContract = new web3.eth.Contract(erc20ABI, checksumToken1);
                const amountIn = web3.utils.toWei(amount1, 'ether');
                const totalAmount = web3.utils.toBN(amountIn).muln(swapCount);
                const allowance = await tokenContract.methods.allowance(accounts[0], checksumSwapContract).call();

                if (web3.utils.toBN(allowance).gte(totalAmount)) {
                    isApproved = true;
                    document.getElementById('approveButton').disabled = true;
                    document.getElementById('swapButton').disabled = false;
                    status.textContent = 'Sufficient allowance exists. You can swap.';
                } else {
                    isApproved = false;
                    document.getElementById('approveButton').disabled = false;
                    document.getElementById('swapButton').disabled = true;
                    status.textContent = 'Approve tokens to swap.';
                }
            } catch (error) {
                status.textContent = 'Error checking allowance: ' + error.message;
                console.error('Allowance check error:', error.message, error.stack);
            }
        }

        async function approveTokens() {
            const token1 = document.getElementById('token1').value;
            const amount1 = document.getElementById('amount1').value;
            const swapCount = parseInt(document.getElementById('swapCount').value);
            const status = document.getElementById('status');

            if (!token1 || !amount1 || amount1 <= 0 || !swapCount || swapCount < 1 || swapCount > 10) {
                status.textContent = 'Please select a token, enter a valid amount (min 0.0001), and a swap count (1-10).';
                return;
            }

            if (parseFloat(amount1) < 0.0001) {
                status.textContent = 'Amount must be at least 0.0001 tokens.';
                return;
            }

            if (!web3 || !accounts || !accounts.length) {
                status.textContent = 'Please connect your wallet first.';
                return;
            }

            try {
                const checksumToken1 = web3.utils.toChecksumAddress(token1);
                const checksumSwapContract = web3.utils.toChecksumAddress(swapContractAddress);
                const tokenContract = new web3.eth.Contract(erc20ABI, checksumToken1);
                const amountIn = web3.utils.toWei(amount1, 'ether');
                const totalAmount = web3.utils.toBN(amountIn).muln(swapCount);
                
                status.textContent = 'Approving tokens...';
                const gasPrice = await web3.eth.getGasPrice() * 1.2;
                const gas = await tokenContract.methods.approve(checksumSwapContract, totalAmount).estimateGas({ from: accounts[0] });
                const tx = await tokenContract.methods.approve(checksumSwapContract, totalAmount).send({ 
                    from: accounts[0],
                    gasPrice: Math.floor(gasPrice),
                    gas: Math.floor(gas * 1.2)
                });
                totalTxnCount++;
                updateTxnCount();
                isApproved = true;
                status.textContent = 'Tokens approved! You can now swap.';
                document.getElementById('txnLinks').innerHTML += `<div>Approval Tx: <a href="${pharosTestnet.blockExplorerUrls[0]}/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash.slice(0, 6)}...${tx.transactionHash.slice(-4)}</a></div>`;
                document.getElementById('approveButton').disabled = true;
                document.getElementById('swapButton').disabled = false;
                await updateBalance();
            } catch (error) {
                status.textContent = `Approval failed: ${error.code ? `Code ${error.code}: ` : ''}${error.message || 'Unknown error'}`;
                console.error('Approval error:', error.message, error.stack);
            }
        }

        async function swapTokens() {
            const token1 = document.getElementById('token1').value;
            const token2 = document.getElementById('token2').value;
            const amount1 = document.getElementById('amount1').value;
            const swapCount = parseInt(document.getElementById('swapCount').value);
            const status = document.getElementById('status');
            const txnLinks = document.getElementById('txnLinks');

            if (!token1 || !token2 || !amount1 || amount1 <= 0 || !swapCount || swapCount < 1 || swapCount > 10) {
                status.textContent = 'Please select tokens, enter a valid amount (min 0.0001), and a swap count (1-10).';
                return;
            }

            if (parseFloat(amount1) < 0.0001) {
                status.textContent = 'Amount must be at least 0.0001 tokens.';
                return;
            }

            if (token1 === token2) {
                status.textContent = 'Input and output tokens must be different.';
                return;
            }

            if (!web3 || !accounts || !swapContract) {
                status.textContent = 'Please connect your wallet first.';
                return;
            }

            // Check allowance before swapping
            await checkAllowance();
            if (!isApproved) {
                status.textContent = 'Please approve tokens before swapping.';
                return;
            }

            try {
                const checksumToken1 = web3.utils.toChecksumAddress(token1);
                const checksumToken2 = web3.utils.toChecksumAddress(token2);
                const amountIn = web3.utils.toWei(amount1, 'ether');
                const amountOutMin = 0; // Consider adding slippage protection
                const path = [checksumToken1, checksumToken2];
                const deadline = Math.floor(Date.now() / 1000) + 60 * 5; // 5 minutes from now
                const collectionAndSelfcalls = 0; // Fallback value; adjust based on contract requirements

                // Log parameters for debugging
                console.log('Swap parameters:', {
                    token1: checksumToken1,
                    token2: checksumToken2,
                    amountIn: amountIn.toString(),
                    amountOutMin,
                    path,
                    to: accounts[0],
                    deadline,
                    collectionAndSelfcalls,
                    swapCount
                });

                // Prepare multicall data
                const callData = [];
                for (let i = 0; i < swapCount; i++) {
                    const encodedCall = swapContract.methods.swapExactTokensForTokens(
                        amountIn,
                        amountOutMin,
                        path,
                        accounts[0],
                        deadline
                    ).encodeABI();
                    callData.push(encodedCall);
                }

                status.textContent = `Initiating ${swapCount} swap(s) via multicall...`;
                const gasPrice = await web3.eth.getGasPrice() * 1.2;
                let gas;
                try {
                    gas = await swapContract.methods.multicall(collectionAndSelfcalls, callData).estimateGas({ from: accounts[0] });
                } catch (gasError) {
                    status.textContent = `Gas estimation failed: ${gasError.message || 'Unknown error'}`;
                    console.error('Gas estimation error:', gasError.message, gasError.stack);
                    return;
                }
                const tx = await swapContract.methods.multicall(collectionAndSelfcalls, callData).send({ 
                    from: accounts[0],
                    gasPrice: Math.floor(gasPrice),
                    gas: Math.floor(gas * 1.2)
                });
                totalTxnCount++;
                updateTxnCount();
                status.textContent = `All ${swapCount} swaps completed successfully via multicall!`;
                txnLinks.innerHTML += `<div>Multicall Swap Tx: <a href="${pharosTestnet.blockExplorerUrls[0]}/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash.slice(0, 6)}...${tx.transactionHash.slice(-4)}</a></div>`;

                document.getElementById('approveButton').disabled = false;
                document.getElementById('swapButton').disabled = false;
                await updateBalance();
            } catch (error) {
                status.textContent = `Swap process failed: ${error.code ? `Code ${error.code}: ` : ''}${error.message || 'Unknown error'}`;
                console.error('Swap process error:', error.message, error.stack);
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', initWeb3);
        document.getElementById('approveButton').addEventListener('click', approveTokens);
        document.getElementById('swapButton').addEventListener('click', swapTokens);
        document.getElementById('token1').addEventListener('change', checkAllowance);
        document.getElementById('amount1').addEventListener('input', checkAllowance);
        document.getElementById('swapCount').addEventListener('input', checkAllowance);

        // Initialize balance and transaction count on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('balance').textContent = 'Balance: Not connected';
            updateTxnCount();
            updateNetworkStatus();
        });
    </script>
</body>
</html>
